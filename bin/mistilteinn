# -*- mode:ruby; coding:utf-8 -*-
require 'pp'
require 'subcommand'
require 'mistilteinn/config'
require 'mistilteinn/git'
require 'mistilteinn/ticket'

include Subcommands
options  = {}
action   = {}

global_options do|opts|
  options[:config] = File.expand_path '.mistilteinn/config.yaml', Mistilteinn::Git.root
  opts.on('-c CONFIG', '--config=CONIF') do|config|
    options[:config] = config
  end
end

command :list do|opts|
  opts.description = 'show current ticket list'
  action[:list] = lambda do|config, options,_|
    klass = Mistilteinn::Ticket[config.ticket.source]
    its   = klass.new config
    its.tickets.each do|entry|
      puts entry.format
    end
  end
end

command :create do|opts|
  opts.description = 'create ticket'
  action[:create] = lambda do|config, options,args|
0    klass = Mistilteinn::Ticket[config.ticket.source]
    its   = klass.new config
    its.create args.join(' ')
  end
end

cmd = opt_parse
config = Mistilteinn::Config.load options[:config]
action[cmd.to_sym][config, options, ARGV]
